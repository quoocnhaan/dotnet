@using WebApp.Data

@model List<CartItem>

@{
    ViewData["Title"] = "Cart Index";
    double grandTotal = Model.Sum(ci => ci.GetTotal() ?? 0);
}
<div class="container">
    <div class="cart_inner">
        @if (TempData["CartWarnings"] != null)
        {
            <div class="alert alert-warning">@Html.Raw(TempData["CartWarnings"])</div>
        }
        <form asp-controller="Cart" asp-action="Update" method="post">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">Product</th>
                            <th scope="col">Price</th>
                            <th scope="col">Quantity</th>
                            <th scope="col">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            @for (int i = 0; i < Model.Count; i++)
                            {
                                var cartItem = Model[i];
                                <input type="hidden" name="cartItems[@i].Id" value="@cartItem.Id" />
                                <tr>
                                    <td>
                                        <div class="media">
                                            <div class="d-flex">
                                                <img src="@Url.Content("~/" + cartItem.Product?.ImageUrl)" alt="@cartItem.Product?.Name" style="width:80px;height:auto;" />
                                            </div>
                                            <div class="media-body">
                                                <p>@cartItem.Product?.Name</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <h5>@cartItem.Product?.GetPriceAfterDiscount().ToString("C")</h5>
                                    </td>

                                    <td>
                                        <div class="product_count">
                                        @if (cartItem.Product?.Quantity > 0)
                                            {
                                                <label for="sst_@cartItem.Product?.Id">Quantity:</label>
                                                <input type="hidden" name="cartItems[@i].ProductId" value="@cartItem.Product?.Id" />
                                                <input type="hidden" name="returnUrl" value="@Context.Request.Path" />
                                                <input type="number"
                                                name="cartItems[@i].Quantity"
                                                id="sst_@cartItem.Product?.Id"
                                                maxlength="12"
                                                value="@cartItem.Quantity"
                                                min="0"
                                                max="@(cartItem.Product?.Quantity)"
                                                title="Quantity:"
                                                class="input-text qty"
                                                oninput="let max=@(cartItem.Product?.Quantity); if(this.value> max) this.value = max; if(this.value < 0) this.value = 0; updateTotal(@cartItem.Product?.Id, @cartItem.Product?.GetPriceAfterDiscount());" />
                                                <button type="button" class="increase items-count"
                                                onclick="var result = document.getElementById('sst_@cartItem.Product?.Id'); var sst=parseInt(result.value);if (!isNaN(sst) && sst < @cartItem.Product?.Quantity) { result.value = sst + 1; updateTotal(@cartItem.Product?.Id, @cartItem.Product?.GetPriceAfterDiscount());} return false;">
                                                    <i class="lnr lnr-chevron-up"></i>
                                                </button>
                                                <button type="button" class="reduced items-count"
                                                onclick="var result = document.getElementById('sst_@cartItem.Product?.Id'); var sst=parseInt(result.value); if (!isNaN(sst) && sst> 0) { result.value = sst - 1; updateTotal(@cartItem.Product?.Id, @cartItem.Product?.GetPriceAfterDiscount());} return false;">
                                                    <i class="lnr lnr-chevron-down"></i>
                                                </button>
                                            } else
                                            {
                                                <span class="text-danger fw-bold">Out of stock</span>
                                                <input type="hidden" name="cartItems[@i].Quantity" value="0" />
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        <h5 id="total_@cartItem.Product?.Id">
                                            Total: @( cartItem.GetTotal()?.ToString("C", System.Globalization.CultureInfo.CurrentCulture) )
                                        </h5>
                                    </td>
                                </tr>
                            }
                            <tr class="bottom_button">

                                <td>
                                    <button style="cursor: pointer;" type="submit" class="gray_btn">Update Cart</button>
                                </td>

                                <td></td>
                                <td></td>
                                <td>
                                    @* <div class="cupon_text">
                                <input type="text" placeholder="Coupon Code" />
                                <a class="main_btn" href="#">Apply</a>
                                <a class="gray_btn" href="#">Close Coupon</a>
                            </div> *@
                                </td>
                            </tr>
                            <tr>
                                <td></td>
                                <td></td>
                                <td>
                                    <h5>Subtotal</h5>
                                </td>
                                <td>
                                    <h5 id="total">@grandTotal.ToString("C", System.Globalization.CultureInfo.CurrentCulture)</h5>
                                </td>
                            </tr>
                        }
                        else
                        {
                            <tr>
                                <td colspan="4" class="text-center">
                                    <h4>Your cart is empty.</h4>
                                </td>
                            </tr>
                        }
                        <tr class="out_button_area">
                            <td></td>
                            <td></td>
                            <td></td>
                            <td>
                                <div class="checkout_btn_inner">
                                    <a class="gray_btn" href="~/">Continue Shopping</a>
                                    <a class="main_btn" asp-controller="Order" asp-action="Checkout">Proceed to checkout</a>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </form>
    </div>
</div>

<script>
    function updateTotal(productId, unitPrice) {
        const quantity = parseInt(document.getElementById('sst_' + productId).value) || 0;
        const total = unitPrice * quantity;
        document.getElementById('total_' + productId).innerText = 'Total: ' + total.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
    }
</script>

