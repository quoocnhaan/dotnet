@using WebApp.Data

@model Order

@{
    ViewData["Title"] = "Cart Index";

    List<OrderProduct> orderProducts = Model?.OrderProducts?.ToList() ?? new List<OrderProduct>();
}
<div class="container">
    <div class="cart_inner">
        <form asp-controller="Cart" asp-action="Update" method="post">
            <input type="hidden" name="orderId" value="@Model?.Id" />
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">Product</th>
                            <th scope="col">Price</th>
                            <th scope="col">Quantity</th>
                            <th scope="col">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && orderProducts.Any())
                        {
                            @for (int i = 0; i < orderProducts.Count; i++)
                            {
                                var orderProduct = orderProducts[i];
                                <tr>
                                    <td>
                                        <div class="media">
                                            <div class="d-flex">
                                                <img src="@Url.Content("~/" + orderProduct.Product?.ImageUrl)" alt="@orderProduct.Product?.Name" style="width:80px;height:auto;" />
                                            </div>
                                            <div class="media-body">
                                                <p>@orderProduct.Product?.Name</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <h5>@orderProduct.Product?.GetPriceAfterDiscount().ToString("C")</h5>
                                    </td>

                                    <td>
                                        <div class="product_count">
                                            <label for="sst_@orderProduct.Product?.Id">Quantity:</label>
                                            <input type="hidden" name="orderProducts[@i].ProductId" value="@orderProduct.Product?.Id" />
                                            <input type="hidden" name="returnUrl" value="@Context.Request.Path" />
                                            <input type="number"
                                                   name="orderProducts[@i].Quantity"
                                                   id="sst_@orderProduct.Product?.Id"
                                                   maxlength="12"
                                                   value="@orderProduct.Quantity"
                                                   min="0"
                                                   max="@(orderProduct.Product?.Quantity + orderProduct.Quantity)"
                                                   title="Quantity:"
                                                   class="input-text qty"
                                                   oninput="let max=@(orderProduct.Product?.Quantity + orderProduct.Quantity); if(this.value> max) this.value = max; if(this.value < 0) this.value = 0; updateTotal(@orderProduct.Product?.Id, @orderProduct.Product?.GetPriceAfterDiscount());" />
                                            <button type="button" class="increase items-count"
                                                    onclick="var result = document.getElementById('sst_@orderProduct.Product?.Id'); var sst=parseInt(result.value);if (!isNaN(sst) && sst < @orderProduct.Product?.Quantity) { result.value = sst + 1; updateTotal(@orderProduct.Product?.Id, @orderProduct.Product?.GetPriceAfterDiscount());} return false;">
                                                <i class="lnr lnr-chevron-up"></i>
                                            </button>
                                            <button type="button" class="reduced items-count"
                                                    onclick="var result = document.getElementById('sst_@orderProduct.Product?.Id'); var sst=parseInt(result.value); if (!isNaN(sst) && sst> 0) { result.value = sst - 1; updateTotal(@orderProduct.Product?.Id, @orderProduct.Product?.GetPriceAfterDiscount());} return false;">
                                                <i class="lnr lnr-chevron-down"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td>
                                        <h5 id="total_@orderProduct.Product?.Id">
                                            Total: @( orderProduct.GetTotal()?.ToString("C", System.Globalization.CultureInfo.CurrentCulture) )
                                        </h5>
                                    </td>

                                </tr>
                            }
                            <tr class="bottom_button">

                                <td>
                                    <button style="cursor: pointer;" type="submit" class="gray_btn">Update Cart</button>
                                </td>

                                <td></td>
                                <td></td>
                                <td>
                                    @* <div class="cupon_text">
                                <input type="text" placeholder="Coupon Code" />
                                <a class="main_btn" href="#">Apply</a>
                                <a class="gray_btn" href="#">Close Coupon</a>
                            </div> *@
                                </td>
                            </tr>
                            <tr>
                                <td></td>
                                <td></td>
                                <td>
                                    <h5>Subtotal</h5>
                                </td>
                                <td>
                                    <h5 id="total">@Model.GetTotal().ToString("C", System.Globalization.CultureInfo.CurrentCulture)</h5>
                                </td>
                            </tr>
                        }
                        else
                        {
                            <tr>
                                <td colspan="4" class="text-center">
                                    <h4>Your cart is empty.</h4>
                                </td>
                            </tr>
                        }
                        <tr class="out_button_area">
                            <td></td>
                            <td></td>
                            <td></td>
                            <td>
                                <div class="checkout_btn_inner">
                                    <a class="gray_btn" href="~/">Continue Shopping</a>
                                    <a class="main_btn" href="#">Proceed to checkout</a>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </form>
    </div>
</div>

<script>
    function updateTotal(productId, unitPrice) {
        const quantity = parseInt(document.getElementById('sst_' + productId).value) || 0;
        const total = unitPrice * quantity;
        document.getElementById('total_' + productId).innerText = 'Total: ' + total.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
    }
</script>

